<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide + Ace 機器人編輯器</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script src="{{ url_for('static', filename='sylvester.js') }}"></script>
    <script src="{{ url_for('static', filename='PrairieDraw.js') }}"></script>
    <script src="{{ url_for('static', filename='Cango-24v03-min.js') }}"></script>
    <script src="{{ url_for('static', filename='SVGpathUtils-6v03-min.js') }}"></script>
    <script src="{{ url_for('static', filename='gearUtils-09.js') }}"></script>
    <script src="{{ url_for('static', filename='CangoAxes-6v01-min.js') }}"></script>
    <script src="{{ url_for('static', filename='three.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/GLTFLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/controls/OrbitControls.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/RGBELoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/STLLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/OBJLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/MTLLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/ace.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/ext-language_tools.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/mode-python.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/snippets/python.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/FileSaver.min.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/filereader.js') }}"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { flex: 1; min-width: 300px; }
        #kw_editor1 { height: 400px; border: 1px solid #ddd; }
        #brython_div1 { height: 400px; border: 2px solid #007bff; background: #fff; overflow: auto; }
        .controls { margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-run { background: #28a745; color: white; }
        .btn-save { background: #007bff; color: white; }
        .btn-example { background: #17a2b8; color: white; }
        textarea#kw_console1 { width: 100%; height: 120px; font-family: monospace; }
        textarea#program_desc { width: 100%; height: 60px; margin-top: 5px; }
        img.plot-img { max-width: 100%; display: block; margin-bottom: 10px; }
    </style>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
</head>
<body>
<h1>機器人程式編輯器（Pyodide）</h1>
<p>
    <a href="{{ url_for('logout') }}">登出</a> |
    <a href="{{ url_for('programs') }}">查看儲存程式</a> |
    <a href="{{ url_for('brython_test') }}">切換到 Brython 版</a>
</p>

<input type="hidden" id="program_type" value="pyodide">

<div class="container">
    <div class="panel">
        <h3>程式碼編輯區</h3>
        <div id="kw_editor1"></div>
        <div class="controls">
            <button id="kw_run1" class="btn-run">執行程式</button>
            <button id="kw_save_db" class="btn-save">存入資料庫</button>
            <button id="kw_clear_console1">清除輸出</button>
            <button id="clear_bd1">清除畫布</button>
            <button onclick="location.reload()">重新載入</button>
        </div>
        <div>
            <button class="btn-example" id="example1">範例：print</button>
            <button class="btn-example" id="example2">範例：for</button>
            <button class="btn-example" id="example3">範例：random</button>
            <button class="btn-example" id="example4">範例：numpy</button>
            <button class="btn-example" id="example5">範例：matplotlib</button>
        </div>
        <div class="controls">
            <label for="program_desc">程式說明:</label>
            <textarea id="program_desc" placeholder="請輸入程式說明（將與程式一起儲存）"></textarea>
        </div>
    </div>
    <div class="panel">
        <h3>執行畫面</h3>
        <div id="brython_div1"></div>
        <h3>輸出結果</h3>
        <textarea id="kw_console1" readonly>載入 Pyodide 中...</textarea>
    </div>
</div>

<script>
const editor = ace.edit("kw_editor1");
editor.session.setMode("ace/mode/python");
editor.session.setTabSize(4);
editor.session.setUseSoftTabs(true);
editor.setOptions({
    enableLiveAutocompletion: true,
    enableSnippets: true,
    fontSize: "13px"
});
editor.setValue(localStorage["kw_py_src1"] || `print("Hello, Pyodide!")`, -1);
editor.gotoLine(1);

let pyodide = null;
let pyodideReady = false;

async function initPyodide() {
    pyodide = await loadPyodide({
        stdout: msg => kw_console1.value += msg + "\n",
        stderr: msg => kw_console1.value += msg + "\n"
    });
    await pyodide.loadPackage(["numpy", "scipy", "matplotlib", "sympy"]);
    pyodideReady = true;
    kw_console1.value += "Pyodide Ready with numpy, scipy, matplotlib, sympy\n";

    // 自訂 matplotlib plt.show()
    await pyodide.runPythonAsync(`
import matplotlib.pyplot as plt
import io, base64
from js import brython_div1

def custom_show():
    fig = plt.gcf()
    buf = io.BytesIO()
    fig.savefig(buf, format='png')
    buf.seek(0)
    img_b64 = base64.b64encode(buf.read()).decode('utf-8')
    brython_div1.innerHTML += f'<img class="plot-img" src="data:image/png;base64,{img_b64}">'
    # 不要 plt.close(fig) 以避免錯誤

plt.show = custom_show
    `);
}
initPyodide();

async function run_code() {
    kw_console1.value = "執行中...\n";
    brython_div1.innerHTML = "";
    localStorage["kw_py_src1"] = editor.getValue();
    if (!pyodideReady) {
        kw_console1.value += "Pyodide 尚未載入完成\n";
        return;
    }
    try {
        // 導 stdout / stderr 到 kw_console1
        await pyodide.runPythonAsync(`
import sys
class JsWriter:
    def write(self, s):
        from js import kw_console1
        kw_console1.value += s
        kw_console1.scrollTop = kw_console1.scrollHeight
sys.stdout = JsWriter()
sys.stderr = JsWriter()
        `);

        await pyodide.runPythonAsync(editor.getValue());
        kw_console1.value += "\n<completed>\n";
    } catch (e) {
        kw_console1.value += e + "\n";
    }
}

kw_run1.onclick = run_code;
document.getElementById('clear_bd1').onclick = function() {
    brython_div1.innerHTML = ""; // 清空圖像
};
kw_clear_console1.onclick = () => kw_console1.value = "";

example1.onclick = () => editor.setValue(`print("Hello Pyodide")`, -1);
example2.onclick = () => editor.setValue(`for i in range(5):\n    print(i)`, -1);
example3.onclick = () => editor.setValue(`import random\nprint(random.randint(1, 10))`, -1);
example4.onclick = () => editor.setValue(`import numpy as np\na = np.array([1,2,3])\nprint(a * 2)`, -1);
example5.onclick = () => editor.setValue(`
import matplotlib.pyplot as plt
plt.plot([1,2,3],[4,5,6])
plt.title("Example")
plt.xlabel("X axis")
plt.ylabel("Y axis")
plt.show()
`, -1);

// 存檔邏輯留空（可依需求填寫）
document.getElementById('kw_save_db').addEventListener('click', function() {
    const code = editor.getValue().trim();
    const desp = document.getElementById('program_desc').value.trim();
    const type = document.getElementById('program_type').value;
    // TODO: 存檔至資料庫
});
</script>
</body>
</html>
