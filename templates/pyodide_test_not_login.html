<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide + Ace 機器人編輯器</title>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <!-- 其他 JS 庫 -->
    <script src="{{ url_for('static', filename='sylvester.js') }}"></script>
    <script src="{{ url_for('static', filename='PrairieDraw.js') }}"></script>
    <script src="{{ url_for('static', filename='Cango-24v03-min.js') }}"></script>
    <script src="{{ url_for('static', filename='SVGpathUtils-6v03-min.js') }}"></script>
    <script src="{{ url_for('static', filename='gearUtils-09.js') }}"></script>
    <script src="{{ url_for('static', filename='CangoAxes-6v01-min.js') }}"></script>
    <script src="{{ url_for('static', filename='three.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/GLTFLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/controls/OrbitControls.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/RGBELoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/STLLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/OBJLoader.js') }}"></script>
    <script src="{{ url_for('static', filename='jsm/loaders/MTLLoader.js') }}"></script>
    <!-- Ace Editor -->
    <script src="{{ url_for('static', filename='ace/ace.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/ext-language_tools.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/mode-python.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/snippets/python.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/FileSaver.min.js') }}"></script>
    <script src="{{ url_for('static', filename='ace/filereader.js') }}"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { flex: 1; min-width: 300px; }
        #kw_editor1 { height: 400px; border: 1px solid #ddd; }
        #brython_div1 { height: 400px; border: 2px solid #007bff; background: #fff; overflow: auto; display:flex; align-items:center; justify-content:center;}
        .controls { margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-run { background: #28a745; color: white; }
        .btn-example { background: #17a2b8; color: white; }
        textarea#kw_console1 { width: 100%; height: 120px; font-family: monospace; }
        textarea#program_desc { width: 100%; height: 60px; margin-top: 5px; }
        img.plot-img { max-width: 100%; max-height: 100%; }
    </style>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
<h1>機器人程式編輯器（Pyodide）</h1>
<p>
    <a href="{{ url_for('login') }}">登入</a> |
    <a href="{{ url_for('programs') }}">查看儲存程式</a>
</p>

<span id="search_toggle" style="color:#0066cc;cursor:pointer;text-decoration:underline;">程式查詢</span>

<input type="hidden" id="program_type" value="pyodide">

<div id="search_panel" style="display:none;margin:15px 0;padding:15px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;">
    <form id="search_form" style="margin-bottom:10px;">
        <input type="text" id="search_query"
               placeholder="搜尋：帳號、程式碼、來源、備註、說明、類型"
               style="width:380px;padding:8px;font-size:14px;border:1px solid #ccc;border-radius:4px;">
        <button type="submit" style="padding:8px 16px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:5px;">搜尋</button>
        <button type="button" id="search_close" style="padding:8px 16px;background:#6c757d;color:white;border:none;border-radius:4px;cursor:pointer;margin-left:5px;">關閉</button>
    </form>
    <div id="search_results"></div>
</div>

<div class="container">
    <div class="panel">
        <h3>程式碼編輯區</h3>
        <div id="kw_editor1"></div>
        <div class="controls">
            <button id="kw_run1" class="btn-run">執行程式</button>
            <button id="kw_clear_console1">清除輸出</button>
            <button id="clear_bd1">清除畫布</button>
            <button onclick="location.reload()">重新載入</button>
        </div>
        <div>
            <button class="btn-example" id="example1">範例：print</button>
            <button class="btn-example" id="example2">範例：for</button>
            <button class="btn-example" id="example3">範例：random</button>
            <button class="btn-example" id="example4">範例：numpy</button>
            <button class="btn-example" id="example5">範例：matplotlib</button>
        </div>
        <div class="controls">
            <label for="program_desc">程式說明:</label>
            <textarea id="program_desc" placeholder="請先登入才能儲存程式與說明" disabled></textarea>
        </div>
    </div>
    <div class="panel">
        <h3>執行畫面</h3>
        <div id="brython_div1"></div>
        <h3>輸出結果</h3>
        <textarea id="kw_console1" readonly>載入 Pyodide 中...</textarea>
    </div>
</div>

<script>
// Ace Editor 初始化
const editor = ace.edit("kw_editor1");
editor.session.setMode("ace/mode/python");
editor.session.setTabSize(4);
editor.session.setUseSoftTabs(true);
editor.setOptions({
    enableLiveAutocompletion: true,
    enableSnippets: true,
    fontSize: "13px"
});
editor.setValue(localStorage["kw_py_src1"] || `print("Hello, Pyodide!")`, -1);
editor.gotoLine(1);

// Pyodide 初始化
let pyodide = null;
let pyodideReady = false;

async function initPyodide() {
    pyodide = await loadPyodide();
    await pyodide.loadPackage(["numpy","scipy","matplotlib","sympy"]);
    pyodideReady = true;
    kw_console1.value = "Pyodide Ready with numpy, scipy, matplotlib, sympy\n";
}
initPyodide();

// 執行程式
async function run_code() {
    kw_console1.value = "執行中...\n";
    brython_div1.innerHTML = "";
    localStorage["kw_py_src1"] = editor.getValue();
    if (!pyodideReady) {
        kw_console1.value += "Pyodide 尚未載入完成\n";
        return;
    }
    try {
        // 文字輸出重定向
        await pyodide.runPythonAsync(`
import sys
class JsWriter:
    def write(self, s):
        from js import kw_console1
        kw_console1.value += s
        kw_console1.scrollTop = kw_console1.scrollHeight
    def flush(self):
        pass
sys.stdout = JsWriter()
sys.stderr = JsWriter()
        `);

        // 將 plt.show() 也改為輸出到 div
        await pyodide.runPythonAsync(`
import matplotlib.pyplot as plt
from matplotlib.backends.backend_agg import FigureCanvasAgg
import io, base64
import builtins

def custom_show():
    fig = plt.gcf()
    canvas = FigureCanvasAgg(fig)
    buf = io.BytesIO()
    canvas.print_png(buf)
    buf.seek(0)
    img_b64 = base64.b64encode(buf.read()).decode('utf-8')
    from js import brython_div1
    brython_div1.innerHTML = f'<img class="plot-img" src="data:image/png;base64,{img_b64}">'

# 替換 plt.show
plt.show = custom_show
        `);

        // 執行使用者程式
        await pyodide.runPythonAsync(editor.getValue());

        kw_console1.value += "\n<completed>\n";
    } catch(e) {
        kw_console1.value += e + "\n";
    }
}

kw_run1.onclick = run_code;
document.getElementById('clear_bd1').onclick = function() {
    brython_div1.innerHTML = ""; // 清空圖像
};
kw_clear_console1.onclick = () => kw_console1.value = "";

// 範例按鈕
example1.onclick = () => editor.setValue(`print("Hello Pyodide!")`, -1);
example2.onclick = () => editor.setValue(`for i in range(5):\n    print(i)`, -1);
example3.onclick = () => editor.setValue(`import random\nprint(random.randint(1, 10))`, -1);
example4.onclick = () => editor.setValue(`import numpy as np\na = np.array([1,2,3])\nprint(a * 2)`, -1);
example5.onclick = () => editor.setValue(`import matplotlib.pyplot as plt\nplt.plot([1,2,3],[4,5,6])\nplt.show()`, -1);

// 自動儲存
setInterval(()=>{localStorage["kw_py_src1"] = editor.getValue();}, 1000);

// 搜尋面板控制
document.getElementById('search_toggle').onclick = ()=> {
    const p = document.getElementById('search_panel');
    p.style.display = p.style.display==='none'?'block':'none';
};
document.getElementById('search_close').onclick = ()=> {
    document.getElementById('search_panel').style.display = 'none';
};
document.getElementById('search_form').onsubmit = e=>{
    e.preventDefault();
    const q = document.getElementById('search_query').value.trim();
    performSearch(q,1);
};

function performSearch(q,page=1){
    const div = document.getElementById('search_results');
    div.innerHTML = '<p style="color:#666;">搜尋中...</p>';
    fetch(`/search_programs?q=${encodeURIComponent(q)}&page=${page}`)
        .then(r=>r.json())
        .then(data=>{
            if(!data.programs.length){div.innerHTML='<p style="color:#999;">查無結果</p>'; return;}
            let html=`<table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead style="background:#e9ecef;"><tr>
                <th style="text-align:left;padding:8px;">時間</th>
                <th style="text-align:left;padding:8px;">帳號</th>
                <th style="text-align:left;padding:8px;">類型</th>
                <th style="text-align:left;padding:8px;">程式片段</th>
                <th style="text-align:left;padding:8px;">說明</th>
                <th style="text-align:center;padding:8px;">操作</th>
            </tr></thead><tbody>`;
            data.programs.forEach(p=>{
                const snippet=(p.code_snippet||'').replace(/</g,'&lt;');
                const desp=p.desp?p.desp.replace(/</g,'&lt;'):'<em style="color:#aaa;">(無)</em>';
                html+=`<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px;">${p.time}</td>
                    <td style="padding:8px;">${p.account}</td>
                    <td style="padding:8px;">${p.type||'brython'}</td>
                    <td style="padding:8px;font-family:monospace;font-size:12px;white-space:pre-wrap;">${snippet}</td>
                    <td style="padding:8px;">${desp}</td>
                    <td style="padding:8px;text-align:center;">
                        <a href="/load_program/${p.id}" style="color:#007bff;text-decoration:none;font-weight:bold;">載入</a>
                    </td>
                </tr>`;
            });
            html+='</tbody></table>';
            div.innerHTML=html;
        })
        .catch(err=>{
            div.innerHTML=`<p style="color:red;">載入失敗：${err.message}</p>`;
        });
}

// 自動載入程式
document.addEventListener('DOMContentLoaded', function(){
    const urlParams = new URLSearchParams(window.location.search);
    const loadId = urlParams.get('load');
    if(!loadId) return;
    fetch(`/api/program/${loadId}`)
        .then(r=>r.json())
        .then(data=>{
            if(data.error){alert('程式不存在或無法載入'); return;}
            if(data.type!=='pyodide'){
                window.location.href = `/brython_test?load=${loadId}`;
                return;
            }
            waitForAce(()=>{editor.setValue(data.code||'',-1); document.getElementById('program_desc').value=data.desp||'';});
        })
        .catch(()=>alert('載入失敗'));
});

function waitForAce(callback, attempts=100){
    if(attempts===0){alert('編輯器載入失敗'); return;}
    const ed = window.ace && ace.edit("kw_editor1");
    if(ed) callback();
    else setTimeout(()=>waitForAce(callback, attempts-1),100);
}
</script>
</body>
</html>
